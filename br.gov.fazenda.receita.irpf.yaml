app-id: br.gov.fazenda.receita.irpf
runtime: org.gnome.Platform
runtime-version: '43'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk11
tags: [proprietary]
command: irpf
finish-args:
  - --share=network
  - --socket=x11
  - --share=ipc
  - --env=PATH=/app/jre/bin:/app/bin:/usr/bin
  - --env=JAVA_HOME=/app/jre
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfsd
  # Useful to save PDFs and whatnot.
  - --filesystem=xdg-documents
  # This path is hardcoded by the app to save all kinds of tax data.
  - --filesystem=~/ProgramasRFB:create
  # User-defined preferences (such as hiding the welcome window) are stored under: ~/.java/.userPrefs/serpro/ppgd/irpf/prefs.xml
  - --persist=.java
  # Log files, tokens and whatnot.
  - --persist=.receitanet
  # User-provided form data (such as CPF and CNPJ numbers) are stored under: ~/.rfb/.cacheni.properties
  - --persist=.rfb
modules:
  - name: irpf
    buildsystem: simple
    build-commands:
      - install -Dm755 -t /app/bin irpf
      - install -Dm644 -t /app/share/applications br.gov.fazenda.receita.irpf.desktop
      - install -Dm644 icon-64.png /app/share/icons/hicolor/64x64/apps/br.gov.fazenda.receita.irpf.png
      - install -Dm644 icon-128.png /app/share/icons/hicolor/128x128/apps/br.gov.fazenda.receita.irpf.png
      - install -Dm644 icon-256.png /app/share/icons/hicolor/256x256/apps/br.gov.fazenda.receita.irpf.png
      - install -Dm644 -t /app/share/metainfo br.gov.fazenda.receita.irpf.metainfo.xml
      - install -Dm644 -t /app/share/br.gov.fazenda.receita.irpf irpf.jar pgd-updater.jar
      - cp -r --no-preserve=mode help/ lib/ lib-modulos/ /app/share/br.gov.fazenda.receita.irpf
      # Workaround to make the clickable link on the "About" window open with the default web browser.
      - ln -s /usr/bin/xdg-open /app/bin/firefox
    sources:
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/arquivos/IRPF2022-1.8.zip
        sha256: 33bbef2ad800b36734d5992210b58abd536fdaea7705a5fd8b384f56a627468d
        x-checker-data:
          type: html
          url: https://www.gov.br/receitafederal/pt-br/centrais-de-conteudo/download/pgd/dirpf
          version-pattern: /arquivos/IRPF([\d.-]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/$major/irpf/arquivos/IRPF$version.zip
      - type: script
        dest-filename: irpf
        commands:
          - exec java -jar /app/share/br.gov.fazenda.receita.irpf/irpf.jar $@
      - type: file
        path: br.gov.fazenda.receita.irpf.metainfo.xml
      - type: file
        path: br.gov.fazenda.receita.irpf.desktop
      - type: file
        path: icon-64.png
      - type: file
        path: icon-128.png
      - type: file
        path: icon-256.png

  - name: irpf_xml
    buildsystem: simple
    build-commands:
      - install -Dm644 *.xml /app/share/br.gov.fazenda.receita.irpf/lib/resources
    # The zipped files below contain XML files, which are used to update internal table values within the program.
    # These files are supposed to be automatically updated by the program, but since the program doesn't know we're
    # running it via Flatpak, it fails trying to overwrite the already existing XML files under /app.
    #
    # So, to mitigate this problem, I made a script to help me keep these XML files updated within this manifest.
    # Just run it like so:
    #
    # ./tools/update-zip-assets.py -x -m br.gov.fazenda.receita.irpf.yaml
    sources:
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/AJUST__20211221_20220305123016.zip
        sha256: 8ad0d5956c9b8387a146e7abf293609aa7f85566a651e0ad89b8ebc3e8b60a12
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: AJUST__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/AJUST__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BANCO__20230120_20230120021530.zip
        sha256: 2388d18a354ba0b1817517ad3e59f4875b18edcea90fd65bcbb96fe8c1ca34a3
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: BANCO__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BANCO__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BBENS__20230113_20230113021604.zip
        sha256: 366f7367cddc325dc34546ebdeb374a94c6527922e69ac6eb4e0b56bff5efced
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: BBENS__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BBENS__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BENSD__20220305_20220305201914.zip
        sha256: 16df7816469f8774563f5b70b2d42cb0bf9c841e1fd3d331c2c5d4506a320902
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: BENSD__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/BENSD__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/CFVAL__20220409_20220409021504.zip
        sha256: c6183e35166ac90007afb9183b0b967ee8ac0af6e55abe507189efcbf6f66b51
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: CFVAL__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/CFVAL__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/DEPEN__20220222_20220305123016.zip
        sha256: b2c76197a2e641acd8c8406be9afe987dce1333cbf58adc98cebee46cececbe3
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: DEPEN__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/DEPEN__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/DIVID__20211211_20220305123016.zip
        sha256: 371ea819cb384b337bae64b51e20e621301e669c9a5fce70f8108322b5ca1fc7
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: DIVID__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/DIVID__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/ECA__20220217_20220305124320.zip
        sha256: 26fd7670b1afbc70608eaff44c2bc1732f4d53546fd72e03c2bef2cf3c4e0ac2
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: ECA__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/ECA__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/IDOSO__20220217_20220305124320.zip
        sha256: bd81466a14af8a3123f945250876e0f71b04f23420f856b4cb7c9595ee9ecabf
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: IDOSO__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/IDOSO__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/LINKS__20221124_20221125021625.zip
        sha256: 704a973481d2dc969f043f58965cd7bad5f73714310542c673dea1608ccb4f10
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: LINKS__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/LINKS__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/MSGS__20220601_20220601021533.zip
        sha256: dadd8da42866ec081508143d565d5a2377ce460ec61e0a3d149e40b19801785c
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: MSGS__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/MSGS__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/NATOC__20211211_20220305123016.zip
        sha256: 4e592e13d4709842973d85d0f7828b6d7acbb8f2bbe1a8b5d90188da5783ef22
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: NATOC__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/NATOC__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/OCPRI__20220301_20220305123016.zip
        sha256: e0eabb8f10b3202cab42e095006088ca41ef9fdf2e3345788c78e80a603e4bb4
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: OCPRI__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/OCPRI__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/PAIS__20220526_20220526021506.zip
        sha256: 2518854c2df82d1ea4dc4d44d339a8f2196c803b320e9892b4505439ad41614f
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: PAIS__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/PAIS__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/PGTOS__20220227_20220305123016.zip
        sha256: f089edac9175e4b1a29691abc1d7259492de37226333720236128344d85dab24
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: PGTOS__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/PGTOS__$version.zip
      - type: archive
        url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/RENDI__20220303_20220305123016.zip
        sha256: 1f9e426cb4bb3a24cd4c5a1905bb42412ec76d41953d111b5f8851087c89d0d8
        strip-components: 2
        x-checker-data:
          type: html
          url: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/latest.xml
          version-pattern: RENDI__([\d_]+)\.zip
          url-template: https://downloadirpf.receita.fazenda.gov.br/irpf/2022/irpf/update/RENDI__$version.zip
    modules:
      - name: openjdk
        buildsystem: simple
        build-commands:
          - /usr/lib/sdk/openjdk11/install.sh
